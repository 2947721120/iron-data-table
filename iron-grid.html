<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="grid-column.html">
<link rel="import" href="grid-cell.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="iron-grid">
  <template>
    <style>
      :host {
        display: block;
        font: 400 100%/1.5 Roboto, sans-serif;
        font-size: 13px;
        font-weight: 400;
        line-height: 1.1;
        color: rgba(0, 0, 0, 0.87);
        height: 100%;

        overflow: auto;
        position: relative;
        padding-top: var(--iron-grid-row-height, 48px);
      }

      #header {
        background-color: #fafafa;
        display: flex;
        justify-content: space-between;
        color: rgba(0, 0, 0, 0.54);
        font-size: 12px;
        font-weight: 600;
        height: 56px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        transition: box-shadow 200ms;
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 1;
      }

      #header.scrolled {
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06), 0 2px 0 rgba(0, 0, 0, 0.075), 0 3px 0 rgba(0, 0, 0, 0.05), 0 4px 0 rgba(0, 0, 0, 0.015);
      }

      #header > grid-cell,
      .item > grid-cell:not([hidden]) {
        flex: 1 0 100px;
        padding: 0 24px 0 24px;
        height: var(--iron-grid-row-height, 48px);
        display: flex;
        align-items: center;
        overflow: hidden;
      }

      #scroller {
        overflow: auto;
        height: inherit;
      }

      #list {
        height: 100%;
      }

      .item {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #e3e3e3;
        opacity: 1;
      }

      .item:hover {
        background-color: #eee;
      }

      .item:hover div.frozen {
        background-color: #eee;
      }

      .item:after {
        background-color: var(--default-primary-color, #03A9F4);
        bottom: 0;
        content: "";
        height: 2px;
        left: 0;
        pointer-events: none;
        position: absolute;
        right: 0;
        transition: all 0.16s ease-in-out;
        -webkit-transform: scaleX(0.0);
        transform: scaleX(0.0);
        z-index: 1;
      }

      .item[selected]:after {
        -webkit-transform: scaleX(1.0);
        transform: scaleX(1.0);
      }

      .item[selected] {
        -webkit-animation: item-focused 820ms ease-in-out;
        animation: item-focused 820ms ease-in-out;
      }

      @-webkit-keyframes item-focused {
        50% {
          color: #03A9F4;
        }
        100% {
          color: inherit;
        }
      }

      @keyframes item-focused {
        50% {
          color: #03A9F4;
        }
        100% {
          color: inherit;
        }
      }

      .frozen {
        border-right: 1px solid #e3e3e3;
      }

      .checkbox {
        background-color: #fafafa;
        padding: 0 24px 0 24px;
        display: flex;
        align-items: center;
        width: var(--iron-grid-row-height, 48px);
      }
    </style>
    <div id="header">
      <!--div class="checkbox frozen">
          <paper-checkbox checked="[[selected]]"></paper-checkbox>
        </div-->

      <template is="dom-repeat" items="[[columns]]" as="column">
        <grid-cell column="[[column]]" template="[[column.headerTemplate]]" bind="[[column]]"></grid-cell>
      </template>
    </div>

    <iron-list id="list" as="item" items="[[items]]" on-scroll="_onScroll" selection-enabled multi-selection>
      <template>
        <div class="item">
          <!--div class="checkbox frozen">
              <paper-checkbox checked="[[selected]]"></paper-checkbox>
            </div-->
          <template is="dom-repeat" items="[[columns]]" as="column">
            <grid-cell column="[[column]]" template="[[column.template]]" bind="[[item]]"></grid-cell>
          </template>
        </div>
      </template>
    </iron-list>
  </template>

  <script>
    Polymer({
      is: 'iron-grid',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'column-filter-changed': '_onColumnFilterChanged',
        'iron-resize': '_resizeCellContainers',
      },

      observers: ['_filterChanged(filter.*)'],

      properties: {
        items: {
          type: Array
        },

        filter: {
          type: Array,
          notify: true,
          value: []
        },

        lazyItems: {
          type: Function,
          observer: '_lazyItemsChanged'
        },

        size: {
          type: Number,
          value: 0
        },

        _loadedSize: {
          type: Number,
          value: 0
        },

        columns: {
          type: Array,
          notify: true,
          value: function() {
            return Polymer.dom(this).querySelectorAll('grid-column');
          }
        },

        selectionMode: {
          type: String,
          notify: true,
          observer: '_selectionModeChanged',
          value: 'multi'
        }
      },

      /**
       * Selection related functions
       */
      _isSelected: function(mode, selected) {
        if (mode === 'all') {
          return !selected;
        } else {
          return selected;
        }
      },

      _selectAll: function() {
        if (this.selectionMode === 'multi') {
          this.selectionMode = 'all';
        } else {
          this.selectionMode = 'multi';
        }
      },

      _selectionModeChanged: function(mode) {
        this.$.list.clearSelection();
      },

      _filterChanged: function() {
        if (this.items) {
          this.$.list.items = Array.prototype.filter.call(this.items, function(item, index) {
            for (var i = 0; i < this.filter.length; i++) {
              var value = this._deepFind(item, this.filter[i].path);

              if (value.indexOf(this.filter[i].filter) === -1) {
                return false;
              }
            }

            return true;
          }.bind(this));
        }
      },

      _onColumnFilterChanged: function(e) {
        for (var i = 0; i < this.filter.length; i++) {
          if (this.filter[i].path === e.detail.path) {
            this.set('filter.' + i + '.filter', e.detail.filter);
            return;
          }
        }

        this.push('filter', e.detail);
      },

      // we need to find values from deep properties like user.name.first
      // snatched from http://stackoverflow.com/questions/8817394/javascript-get-deep-value-from-object-by-passing-path-to-it-as-string
      _deepFind: function(obj, path) {
        var paths = path.split('.');
        var current = obj;

        for (var i = 0; i < paths.length; ++i) {
          if (current[paths[i]] == undefined) {
            return undefined;
          } else {
            current = current[paths[i]];
          }
        }
        return current;
      },

      _resizeCellContainers: function() {
        // reset header width first to make the cells and scroll width to reset their widths.
        this.$.header.style.width = '';
        this.$.list.style.width = '';

        this.async(function() {
          this.$.header.style.width = this.$.list.scrollWidth;
          this.$.list.style.width = this.$.list.scrollWidth;
        }.bind(this));
      },

      _onScroll: function(e) {

        // TODO: this resize call is to make sure cell containers have correct widths
        // in case there hasn't been any resize events fire yet. Running this on every scroll
        // event is an overkill, so need to find a better place for this.
        this._resizeCellContainers();

        this.translate3d(-this.$.list.scrollLeft + 'px', '0px', '0px', this.$.header);

        var checkboxes = Polymer.dom(this.root).querySelectorAll('.frozen');
        for (var i = 0; i < checkboxes.length; i++) {
          checkboxes[i].style.transform = 'translateX(' + this.$.scroller.scrollLeft + 'px)';
        }

        /*
                if (this.lazyItems !== undefined) {
                  var first = Math.max(this.$.list.firstVisibleIndex - 30, 0);
                  for (var i = first; i < Math.min(first + 30, this.size); i++) {
                    if (Object.keys(this.$.list.items[i]).length === 0) {
                      this._loadItems(i);

                      // force render.
                      this.$.list.notifyResize();

                      return;
                    }
                  }
                }*/

        // Toggle shadow when at the top
        this.toggleClass("scrolled", this.$.list.scrollTop !== 0, this.$.header);
      },

      _loadItems: function(index) {
        var items = this.lazyItems(index, 60);

        for (var i = 0; i < items.length; i++) {
          this.$.list.items[index + i] = items[i];
        }
      },

      _lazyItemsChanged: function(fn) {
        var items = fn(this._loadedSize, 10);

        this._loadedSize = items.length;

        for (var i = items.length; i < this.size; i++) {
          items.push({});
        }

        this.$.list.items = items;
      }
    });
  </script>
</dom-module>
