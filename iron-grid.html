<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="grid-column.html">
<link rel="import" href="grid-cell.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="iron-grid">
  <template>
    <style>
      :host {
        display: block;
        font: 400 100%/1.5 Roboto, sans-serif;
        font-size: 13px;
        font-weight: 400;
        line-height: 1.1;
        color: rgba(0, 0, 0, 0.87);
        height: 400px;
        position: relative;
        overflow: hidden;
        padding-top: 56px; /*header height*/
      }

      #header {
        background-color: #fafafa;
        display: flex;
        justify-content: space-between;
        color: rgba(0, 0, 0, 0.54);
        font-size: 12px;
        font-weight: 600;
        height: 56px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        transition: box-shadow 200ms;
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 1;
      }

      #header.scrolled {
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06), 0 2px 0 rgba(0, 0, 0, 0.075), 0 3px 0 rgba(0, 0, 0, 0.05), 0 4px 0 rgba(0, 0, 0, 0.015);
      }

      #header > grid-cell,
      .item > grid-cell:not([hidden]) {
        flex: 1 0 100px;
        padding: 0 24px 0 24px;
        height: var(--iron-grid-row-height, 48px);
        display: flex;
        align-items: center;
        overflow: hidden;
      }

      #scroller {
        overflow: auto;
        height: inherit;
      }

      .item {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #e3e3e3;
        opacity: 1;
      }

      .item:hover {
        background-color: #eee;
      }

      .item:after {
        background-color: var(--default-primary-color, #03A9F4);
        bottom: 0;
        content: "";
        height: 2px;
        left: 0;
        pointer-events: none;
        position: absolute;
        right: 0;
        transition: all 0.16s ease-in-out;
        -webkit-transform: scaleX(0.0);
        transform: scaleX(0.0);
        z-index: 1;
      }

      .item[selected]:after {
        -webkit-transform: scaleX(1.0);
        transform: scaleX(1.0);
      }

      .item[selected] {
        -webkit-animation: item-focused 820ms ease-in-out;
        animation: item-focused 820ms ease-in-out;
      }

      @-webkit-keyframes item-focused {
        50% {
          color: #03A9F4;
        }
        100% {
          color: inherit;
        }
      }

      @keyframes item-focused {
        50% {
          color: #03A9F4;
        }
        100% {
          color: inherit;
        }
      }

    </style>
    <div id="header">
      <template is="dom-repeat" items="[[columns]]" as="column">
        <grid-cell column="[[column]]" template="[[column.headerTemplate]]" bind="[[column]]"></grid-cell>
      </template>
    </div>

    <div id="scroller" on-scroll="_onScroll">
      <iron-list id="list" as="item" items="[[items]]" selection-enabled>
        <template>
          <div class="item" selected$="[[selected]]">
            <template is="dom-repeat" items="[[columns]]" as="column">
              <grid-cell column="[[column]]" template="[[column.template]]" bind="[[item]]"></grid-cell>
            </template>
          </div>
        </template>
      </iron-list>
    </div>
  </template>

  <script>
    Polymer({
      is: 'iron-grid',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'column-filter-changed': '_onColumnFilterChanged',
        'iron-resize': '_resizeCellContainers',
      },

      observers: ['_filterChanged(filter.*)'],

      properties: {
        items: {
          type: Array
        },

        filter: {
          type: Array,
          notify: true,
          value: []
        },

        columns: {
          type: Array,
          notify: true,
          value: function() {
            return Polymer.dom(this).querySelectorAll('grid-column');
          }
        }
      },

      ready: function() {
        this.$.scroller.scroller = this.$.scroller;
      },

      _filterChanged: function() {
        if (this.items) {
          this.$.list.items = Array.prototype.filter.call(this.items, function(item, index) {
            for (var i = 0; i < this.filter.length; i++) {
              var value = this._deepFind(item, this.filter[i].path);

              if (value.indexOf(this.filter[i].filter) === -1) {
                return false;
              }
            }

            return true;
          }.bind(this));
        }
      },

      _onColumnFilterChanged: function(e) {
        for (var i = 0; i < this.filter.length; i++) {
          if (this.filter[i].path === e.detail.path) {
            this.set('filter.' + i + '.filter', e.detail.filter);
            return;
          }
        }

        this.push('filter', e.detail);
      },

      // we need to find values from deep properties like user.name.first
      // snatched from http://stackoverflow.com/questions/8817394/javascript-get-deep-value-from-object-by-passing-path-to-it-as-string
      _deepFind: function(obj, path) {
        var paths = path.split('.');
        var current = obj;

        for (var i = 0; i < paths.length; ++i) {
          if (current[paths[i]] == undefined) {
            return undefined;
          } else {
            current = current[paths[i]];
          }
        }
        return current;
      },

      _resizeCellContainers: function() {
        // reset header width first to make the cells and scroll width to reset their widths.
        this.$.header.style.width = '';
        this.$.list.style.width = '';

        this.async(function() {
          var scrollBarWidth = this.$.scroller.offsetWidth - this.$.scroller.clientWidth;

          this.$.header.style.width = this.$.scroller.scrollWidth + scrollBarWidth;
          this.$.list.style.width = this.$.scroller.scrollWidth;
        }.bind(this));
      },

      _onScroll: function(e) {

        // TODO: this resize call is to make sure cell containers have correct widths
        // in case there hasn't been any resize events fire yet. Running this on every scroll
        // event is an overkill, so need to find a better place for this.
        this._resizeCellContainers();

        this.translate3d(-this.$.scroller.scrollLeft + 'px', '0px', '0px', this.$.header);

        var checkboxes = Polymer.dom(this.root).querySelectorAll('.frozen');
        for (var i = 0; i < checkboxes.length; i++) {
          checkboxes[i].style.transform = 'translateX(' + this.$.scroller.scrollLeft + 'px)';
        }

        // Toggle shadow when at the top
        this.toggleClass("scrolled", this.$.scroller.scrollTop !== 0, this.$.header);
      }
    });
  </script>
</dom-module>
