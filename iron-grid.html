<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="grid-column.html">
<link rel="import" href="grid-column-sort.html">
<link rel="import" href="grid-cell.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="iron-grid">
  <template>
    <style is="custom-style">
      :host {
        display: block;
        height: 400px;
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        @apply(--iron-data-table-font);
      }

      #container {
        height: inherit;
        display: flex;
        flex-direction: column;
      }

      #header {
        display: flex;
        justify-content: space-between;
        flex-grow: 0;
        flex-shrink: 0;
        @apply(--iron-data-table-header);
      }

      #header.scrolled {
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06), 0 2px 0 rgba(0, 0, 0, 0.075), 0 3px 0 rgba(0, 0, 0, 0.05), 0 4px 0 rgba(0, 0, 0, 0.015);
      }

      #header > grid-cell,
      .item > grid-cell:not([hidden]) {
        flex: 1 0 100px;
        padding: 0 24px 0 24px;
        height: var(--iron-grid-row-height, 48px);
        display: flex;
        align-items: center;
        overflow: hidden;
      }

      #list {
        overflow-x: hidden;
        overflow-y: auto;
        flex-basis: 100%;
        flex-shrink: 1;
        flex-grow: 0;
      }

      .item {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        opacity: 1;
        @apply(--iron-data-table-row);
      }

      .item:hover {
        @apply(--iron-data-table-row-hover);
      }

      .item[selected] {
        @apply(--iron-data-table-row-selected);
      }

      .item[even] {
        @apply(--iron-data-table-row-even);
      }

      .item:not([even]) {
        @apply(--iron-data-table-row-odd);
      }

      .item:after {
        -webkit-transform: scaleX(0.0);
        transform: scaleX(0.0);
        z-index: 1;

        @apply(--iron-data-table-row-underline);
      }

      .item[selected]:after {
        -webkit-transform: scaleX(1.0);
        transform: scaleX(1.0);
      }
    </style>
    <div id="container">
      <div id="header">
        <template is="dom-repeat" items="[[columns]]" as="column">
          <grid-cell column="[[column]]" template="[[column.headerTemplate]]" bind="[[_bind(column)]]">
            <grid-column-sort sort-order="[[sortOrder]]" path="[[column.sort]]" on-sort-direction-changed="_sortDirectionChanged" hidden="[[!column.sort]]"></grid-column-sort>
          </grid-cell>
        </template>
      </div>

      <iron-list id="list" as="item" items="[[items]]" on-scroll="_onVerticalScroll" selection-enabled>
        <template>
          <div class="item" selected$="[[selected]]" even$="[[!_isEven(index)]]">
            <template is="dom-repeat" items="[[columns]]" as="column" index-as="colIndex">
              <grid-cell column="[[column]]" template="[[column.template]]" bind="[[_bind(item, index, selected)]]"></grid-cell>
            </template>
          </div>
        </template>
      </iron-list>
    </div>
  </template>

  <script>
    Polymer({
      is: 'iron-grid',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'column-filter-changed': '_onColumnFilterChanged',
        'iron-resize': '_resizeCellContainers',
        'scroll': '_onHorizontalScroll'
      },

      observers: ['_filterChanged(filter.*)'],

      properties: {
        items: {
          type: Array
        },

        filter: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          }
        },

        sortOrder: {
          type: Object,
          notify: true,
          observer: '_sortOrderChanged',
          value: function() {
            return {};
          }
        },

        columns: {
          type: Array,
          notify: true,
          value: function() {
            return Polymer.dom(this).querySelectorAll('grid-column');
          }
        }
      },

      _bind: function(item, index, selected) {
        return {
          item: item,
          index: index,
          selected: selected
        };
      },

      _isEven: function(index) {
        return index % 2 === 0;
      },

      _filterChanged: function() {
        if (this.items) {
          this.$.list.items = this._filteredAndSortedItems(this.items, this.sortOrder);
        }
      },

      _filter: function(items) {
        return Array.prototype.filter.call(items, function(item, index) {
          for (var i = 0; i < this.filter.length; i++) {
            var value = this._deepFind(item, this.filter[i].path);

            if (value.indexOf(this.filter[i].filter) === -1) {
              return false;
            }
          }

          return true;
        }.bind(this));
      },

      _filteredAndSortedItems: function(items, sortOrder) {
        // filtering creates a new array, which is nice since sorting happens in place.
        var filteredItems = this._filter(this.items);
        return this._sort(filteredItems, sortOrder);
      },

      _sortOrderChanged: function(sortOrder) {
        if (this.items) {
          this.$.list.items = this._filteredAndSortedItems(this.items, sortOrder);
        }
      },

      _sort: function(items, sortOrder) {
        if (sortOrder && sortOrder.path) {
          return Array.prototype.sort.call(items, function(a, b) {
            if (sortOrder.direction === 'asc') {
              return this._compare(this._deepFind(a, sortOrder.path), this._deepFind(b, sortOrder.path));
            } else {
              return this._compare(this._deepFind(b, sortOrder.path), this._deepFind(a, sortOrder.path));
            }
          }.bind(this));
        } else {
          return items;
        }
      },

      _sortDirectionChanged: function(e) {
        this.set('sortOrder', e.detail);
      },

      _compare: function(a, b) {
        if (a < b) {
          return -1;
        }
        if (a > b) {
          return 1;
        }
        return 0;
      },

      _onColumnFilterChanged: function(e) {
        for (var i = 0; i < this.filter.length; i++) {
          if (this.filter[i].path === e.detail.path) {
            this.set('filter.' + i + '.filter', e.detail.filter);
            return;
          }
        }

        this.push('filter', e.detail);
      },

      // we need to find values from deep properties like user.name.first
      // snatched from http://stackoverflow.com/questions/8817394/javascript-get-deep-value-from-object-by-passing-path-to-it-as-string
      _deepFind: function(obj, path) {
        if (path === undefined) {
          return '';
        }

        var paths = path.split('.');
        var current = obj;

        for (var i = 0; i < paths.length; ++i) {
          if (current[paths[i]] == undefined) {
            return undefined;
          } else {
            current = current[paths[i]];
          }
        }
        return current;
      },

      _resizeCellContainers: function() {
        // reset header width first to make the cells and scroll width to reset their widths.
        this.$.container.style.width = '';

        this.async(function() {
          this.$.container.style.width = Math.min(this.scrollWidth, this.clientWidth + this.scrollLeft) + 'px';
        }.bind(this));
      },

      _onHorizontalScroll: function() {
        if (!this.isDebouncerActive('scrolling')) {
          this.$.container.style.width = this.scrollWidth + 'px';
          this.debounce('scrolling', function() {
            this.$.container.style.width = Math.min(this.scrollWidth, this.clientWidth + this.scrollLeft) + 'px';
            // long timeout here to prevent jerkiness with the rubberband effect on iOS especially.
          }, 1000);
        }
      },

      _onVerticalScroll: function(e) {
        // Toggle shadow when at the top
        this.toggleClass("scrolled", this.$.list.scrollTop !== 0, this.$.header);
      }
    });
  </script>
</dom-module>
