<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="grid-column.html">
<link rel="import" href="grid-cell.html">
<link rel="import" href="../iron-list/iron-list.html">

<dom-module id="iron-grid">
  <template>
    <style>
      :host {
        display: block;
        font: 400 100%/1.5 Roboto, sans-serif;
        font-size: 13px;
        font-weight: 400;
        line-height: 1.1;
        color: rgba(0, 0, 0, 0.87);
      }

      #header {
        display: flex;
        justify-content: space-between;
        color: rgba(0, 0, 0, 0.54);
        font-size: 12px;
        height: 56px;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06), 0 2px 0 rgba(0, 0, 0, 0.075), 0 3px 0 rgba(0, 0, 0, 0.05), 0 4px 0 rgba(0, 0, 0, 0.015);
      }

      #header > grid-cell {
        width: 100%;
        padding: 0 24px 0 24px;
        align-self: center;
      }

      #list {
        height: 400px;
      }

      .item {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #e3e3e3;
        opacity: 1;
      }

      .item > grid-cell:not([hidden]) {
        width: 100%;
        overflow: hidden;
        padding: 0 24px 0 24px;
        height: var(--iron-grid-row-height, 48px);
        display: flex;
        align-items: center;
      }
    </style>

    <div id="header">
      <template is="dom-repeat" items="[[columns]]" as="col">
        <grid-cell column="[[col]]" template="[[col.headerTemplate]]" bind="[[col.name]]" hidden="[[col.hidden]]"></grid-cell>
      </template>
    </div>

    <iron-list id="list" as="item" items="[[items]]" on-scroll="_onScroll">
      <template>
        <div class="item">
          <template is="dom-repeat" items="[[columns]]" as="column">
            <grid-cell column="[[column]]" template="[[column.template]]" bind="[[item]]" hidden="[[column.hidden]]"></grid-cell>
          </template>
        </div>
      </template>
    </iron-list>
  </template>

  <script>
    Polymer({
      is: 'iron-grid',

      listeners: {
        'filter-changed': '_onFilterChanged'
      },

      properties: {
        items: {
          type: Array
        },

        lazyItems: {
          type: Function,
          observer: '_lazyItemsChanged'
        },

        size: {
          type: Number,
          value: 0
        },

        _loadedSize: {
          type: Number,
          value: 0
        },

        columns: {
          type: Array,
          notify: true,
          value: function() {
            return Polymer.dom(this).querySelectorAll('grid-column');
          }
        }
      },

      _onFilterChanged: function(e) {
        this._filter = this._filter || {};
        this._filter[e.detail.path] = e.detail.filter;

        if (this.items) {
          this.$.list.items = Array.prototype.filter.call(this.items, function(item, index) {
            for(var prop in this._filter) {
              var value = this._deepFind(item, prop);

              if (value.indexOf(this._filter[prop]) === -1) {
                return false;
              }
            }

            return true;
          }.bind(this));
        }
      },

      // we need to find values from deep properties like user.name.first
      // snatched from http://stackoverflow.com/questions/8817394/javascript-get-deep-value-from-object-by-passing-path-to-it-as-string
      _deepFind: function(obj, path) {
        var paths = path.split('.');
        var current = obj;

        for (var i = 0; i < paths.length; ++i) {
          if (current[paths[i]] == undefined) {
            return undefined;
          } else {
            current = current[paths[i]];
          }
        }
        return current;
      },

      _onScroll: function(e) {
        if (this.lazyItems !== undefined) {
          var first = Math.max(this.$.list.firstVisibleIndex - 30, 0);
          for (var i = first; i < Math.min(first + 30, this.size); i++) {
            if (Object.keys(this.$.list.items[i]).length === 0) {
              this._loadItems(i);

              // force render.
              this.$.list.notifyResize();

              return;
            }
          }
        }
      },

      _loadItems: function(index) {
        var items = this.lazyItems(index, 60);

        for (var i = 0; i < items.length; i++) {
          this.$.list.items[index + i] = items[i];
        }
      },

      _lazyItemsChanged: function(fn) {
        var items = fn(this._loadedSize, 10);

        this._loadedSize = items.length;

        for (var i = items.length; i < this.size; i++) {
          items.push({});
        }

        this.$.list.items = items;
      }
    });
  </script>
</dom-module>
