<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../test-fixture/test-fixture-mocha.js"></script>
  <script src="../lib/treemap.js"></script>
  <link rel="import" href="common.html">
  <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
  <link rel="import" href="../iron-data-table.html">
</head>

<body>
  <script>
    describe('Tree Map', function() {
      var tree;

      beforeEach(function() {
        tree = new TreeMap();
      });

      describe('Returning paths', function() {
        it('should return path on start index', function() {
          tree.add('/', 0, 100);

          expect(tree.getPath(0)).to.eql('/');
        });

        it('should return path on nested index', function() {
          tree.add('/', 0, 100);

          expect(tree.getPath(50)).to.eql('/');
        });

        it('should return path on end index', function() {
          tree.add('/', 0, 100);

          expect(tree.getPath(99)).to.eql('/');
        });

        it('should not return path on missing index', function() {
          tree.add('/', 0, 100);

          expect(tree.getPath(100)).to.be.undefined;
        });
      });

      describe('Returning pages', function() {
        it('should return a single page', function() {
          tree.add('/', 0, 100);

          expect(tree.getPage(20, 10)).to.eql({
            path: '/',
            page: 2
          });
        });

        it('should return a nested page', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 50, 100);

          expect(tree.getPage(60, 10)).to.eql({
            path: '/foo',
            page: 1
          });
        });

        it('should return all requested pages', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 50, 100);

          var pages = tree.getPages(40, 60, 10);

          expect(pages[0]).to.eql({
            path: '/',
            page: 4
          });
          expect(pages[1]).to.eql({
            path: '/foo',
            page: 0
          });
          expect(pages[2]).to.eql({
            path: '/foo',
            page: 1
          });
        });

        it('should return all requested pages in reverse', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 50, 100);

          var pages = tree.getPages(60, 40, 10);

          expect(pages[0]).to.eql({
            path: '/foo',
            page: 1
          });
          expect(pages[1]).to.eql({
            path: '/foo',
            page: 0
          });
          expect(pages[2]).to.eql({
            path: '/',
            page: 4
          });
        });
      });

      describe('Adding nodes', function() {
        it('should add a node', function() {
          tree.add('/', 0, 100);

          expect(tree.getPath(0)).to.eql('/');
        });

        it('should not allow adding duplicate paths', function() {
          tree.add('/', 0, 100);

          expect(function() {
            tree.add('/', 0, 100);
          }).to.throw(Error);
        });

        it('should add a second node at the end', function() {
          tree.add('/', 0, 100);

          tree.add('/foo', 100, 100);

          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.eql('/foo');
        });

        it('should add a second node at the beginning', function() {
          tree.add('/', 0, 100);

          tree.add('/foo', 0, 100);

          expect(tree.getPath(99)).to.eql('/foo');
          expect(tree.getPath(100)).to.eql('/');
        });

        it('should add a third node in the middle', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 100, 100);

          tree.add('/bar', 100, 100);

          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.eql('/bar');
          expect(tree.getPath(199)).to.eql('/bar');
          expect(tree.getPath(200)).to.eql('/foo');
        });

        it('should split a node in half', function() {
          tree.add('/', 0, 100);

          tree.add('/foo', 50, 100);

          expect(tree.getPath(49)).to.eql('/');
          expect(tree.getPath(50)).to.eql('/foo');
          expect(tree.getPath(149)).to.eql('/foo');
          expect(tree.getPath(150)).to.eql('/');
        });

        it('should update indexes after splitting', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 100, 100);

          tree.add('/bar', 50, 100);

          expect(tree.getPath(49)).to.eql('/');
          expect(tree.getPath(50)).to.eql('/bar');
          expect(tree.getPath(149)).to.eql('/bar');
          expect(tree.getPath(150)).to.eql('/');
          expect(tree.getPath(199)).to.eql('/');
          expect(tree.getPath(200)).to.eql('/foo');
        });
      });

      describe('Removing nodes', function() {
        it('should remove a node from the end', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 100, 100);

          tree.remove('/foo');

          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.be.undefined;
        });

        it('should remove a node from the beginning', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 100, 100);

          tree.remove('/');

          expect(tree.getPath(99)).to.eql('/foo');
          expect(tree.getPath(100)).to.be.undefined;
        });

        it('should remove a node from the middle', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 100, 100);
          tree.add('/bar', 200, 100);

          tree.remove('/foo');

          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.eql('/bar');
        });

        it('should combine a splitted node', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 50, 100);

          tree.remove('/foo');

          expect(tree.getPath(49)).to.eql('/');
          expect(tree.getPath(50)).to.eql('/');
          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.be.undefined;

          expect(tree._nodes.length).to.eql(1);
        });

        it('should remove nested nodes', function() {
          tree.add('/', 0, 100);
          tree.add('/foo', 50, 100);
          tree.add('/bar', 100, 100);

          tree.remove('/foo');

          expect(tree.getPath(49)).to.eql('/');
          expect(tree.getPath(50)).to.eql('/');
          expect(tree.getPath(99)).to.eql('/');
          expect(tree.getPath(100)).to.be.undefined;
        });
      });
    });
  </script>

</body>

</html>
