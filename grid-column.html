<link rel="import" href="grid-column-filter.html">

<dom-module id="grid-column">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <template id="header">
      <grid-column-filter name="[[item.name]]" path="[[item.filter]]" hidden="[[!item.filter]]"></grid-column-filter>
      <div hidden="[[item.filter]]">[[item.name]]</div>
    </template>

  </template>
  <script>
    Polymer({
      is: 'grid-column',

      behaviors: [
        Polymer.Templatizer,
      ],

      properties: {
        alignRight: Boolean,

        name: {
          type: String,
          notify: true,
          value: ''
        },

        filter: {
          type: String
        },

        width: {
          type: String,
          notify: true,
          value: "100px"
        },

        flex: {
          type: Number,
          notify: true,
          value: 1
        },

        hidden: {
          type: Boolean,
          notify: true,
          value: false
        },

        order: {
          type: Number,
          notify: true
        },

        sort: {
          type: String
        },

        headerTemplate: {
          type: Object,
          value: function() {
            return Polymer.dom(this.root).querySelector('#header');
          }
        },

        template: {
          type: Object,
          value: function() {
            return Polymer.dom(this).querySelector('template');
          }
        },

        _templateInstances: {
          type: Array,
          value: function() {
            return [];
          }
        },

        _forwardedParentProps: {
          type: Object,
          value: function() {
            return {};
          }
        }
      },

      observers: ['_forwardedParentPropsChanged(_forwardedParentProps.*)',
        '_templateInstancesChanged(_templateInstances.splices)'
      ],

      _forwardParentProp: function(prop, value) {
        this.set('_forwardedParentProps.' + prop, value);
      },

      _forwardedParentPropsChanged: function(changeRecord) {
        // TODO: need to make sure this works with nested paths also. [[foo.bar]] etc.
        for (var prop in changeRecord.base) {
          this._templateInstances.forEach(function(t) {
            t[prop] = changeRecord.base[prop];
          });
        }
      },

      _templateInstancesChanged: function(changeRecord) {
        // TODO: (Saulis) make sure _templateInstances length is correct. Earlier testing seems producing weird results.
        if (changeRecord && changeRecord.indexSplices) {

          changeRecord.indexSplices.forEach(function(s) {
            var addedInstance = s.object[s.index];

            for (var prop in this._forwardedParentProps) {
              addedInstance[prop] = this._forwardedParentProps[prop];
            }
          });
        }
      },

      ready: function() {
        // we need to templatize all user-provided templates asap to prevent [[item...]] from being
        // bound to a parent dom-bind template or a parent web component.
        // Note (Saulis): if the internal templates have something else than [[item..]] they will get screwed when setting properi
        this._instanceProps = {
          item: true,
          index: true,
          selected: true
        };
        this.templatize(Polymer.dom(this).querySelector('template'));
      }
    });
  </script>
</dom-module>
